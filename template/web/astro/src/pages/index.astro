---
import { Footer, Header } from "@ui/shadcn";
import "../styles/global.css";

const sections = [
  { id: "section-1", title: "Section 1", color: "section--one" },
  { id: "section-2", title: "Section 2", color: "section--two" },
  { id: "section-3", title: "Section 3", color: "section--three" },
  { id: "section-4", title: "Section 4", color: "section--four" },
  { id: "section-5", title: "Section 5", color: "section--five" },
];
---

<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Monorepo Astro Template</title>
    <meta name="description" content="Astro app template using @ui/shadcn" />
  </head>
  <body>
    <div class="template-root">
      <Header />

      <main class="template-body">
        <section id="table-section" class="table-section">
          <h2>User + Task Table</h2>
          <p>Click Header `Table` to create user and related task rows.</p>
          <div class="table-shell">
            <table>
              <thead data-table-head></thead>
              <tbody data-table-body>
                <tr>
                  <td colspan="4">No rows yet. Use Header Table menu.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        {
          sections.map((section) => (
            <section id={section.id} class={`section ${section.color}`}>
              <h2>{section.title}</h2>
            </section>
          ))
        }
      </main>

      <div class="mobile-sidemenu__overlay" data-menu-overlay></div>
      <aside
        id="mobile-sidemenu"
        class="mobile-sidemenu"
        aria-hidden="true"
        data-mobile-sidemenu
      >
        <div class="mobile-sidemenu__header">
          <strong>Menu</strong>
          <button type="button" class="mobile-sidemenu__close" data-menu-close aria-label="Close menu">
            닫기
          </button>
        </div>
        <nav class="mobile-sidemenu__nav" aria-label="Mobile menu">
          {
            sections.map((section) => (
              <a href={`#${section.id}`} data-menu-link>
                {section.title}
              </a>
            ))
          }
        </nav>
      </aside>

      <Footer />
    </div>
    <script>
      import { createColumnHelper } from "@tanstack/table-core";
      import Lenis from "../lib/lenis";

      const sections = Array.from(document.querySelectorAll<HTMLElement>(".section"));
      const menuButton = document.querySelector<HTMLButtonElement>(".template-header__menu");
      const sideMenu = document.querySelector<HTMLElement>("[data-mobile-sidemenu]");
      const menuOverlay = document.querySelector<HTMLElement>("[data-menu-overlay]");
      const closeButton = document.querySelector<HTMLButtonElement>("[data-menu-close]");
      const menuLinks = Array.from(document.querySelectorAll<HTMLAnchorElement>("[data-menu-link]"));
      const tableActionLink = document.querySelector<HTMLAnchorElement>("[data-table-action]");
      const allAnchorLinks = Array.from(document.querySelectorAll<HTMLAnchorElement>('a[href^="#"]'));
      const tableHead = document.querySelector<HTMLElement>("[data-table-head]");
      const tableBody = document.querySelector<HTMLElement>("[data-table-body]");

      const lenis = new Lenis({
        duration: 1,
        smoothWheel: true,
        syncTouch: true,
      });
      const rows: UserTaskRow[] = [];
      let seedCount = 1;

      let rafId = 0;
      let snapTimer = 0;
      let isSnapping = false;

      const setMenuOpen = (open: boolean) => {
        document.body.classList.toggle("menu-open", open);
        sideMenu?.setAttribute("aria-hidden", String(!open));
        menuButton?.setAttribute("aria-expanded", String(open));
      };

      const snapToNearestSection = () => {
        if (
          isSnapping ||
          sections.length === 0 ||
          (window.innerWidth < 768 && document.body.classList.contains("menu-open"))
        ) {
          return;
        }

        const currentY = window.scrollY;
        const tops = sections.map((section) => section.offsetTop);

        let targetTop = tops[0];

        for (let index = 0; index < tops.length; index += 1) {
          const currentTop = tops[index];
          const nextTop = tops[index + 1];

          if (nextTop === undefined) {
            targetTop = currentTop;
            break;
          }

          if (currentY >= currentTop && currentY < nextTop) {
            const halfPoint = currentTop + (nextTop - currentTop) / 2;
            targetTop = currentY >= halfPoint ? nextTop : currentTop;
            break;
          }
        }

        if (Math.abs(targetTop - currentY) < 6) {
          return;
        }

        isSnapping = true;
        lenis.scrollTo(targetTop, {
          duration: 0.75,
          lock: true,
          onComplete: () => {
            isSnapping = false;
          },
        });
      };

      type UserTaskRow = {
        userName: string;
        userEmail: string;
        taskTitle: string;
        taskStatus: string;
      };

      const columnHelper = createColumnHelper<UserTaskRow>();
      const columns = [
        columnHelper.accessor("userName", { id: "userName", header: "User" }),
        columnHelper.accessor("userEmail", { id: "userEmail", header: "Email" }),
        columnHelper.accessor("taskTitle", { id: "taskTitle", header: "Task" }),
        columnHelper.accessor("taskStatus", { id: "taskStatus", header: "Status" }),
      ];

      const escapeHtml = (value: string) =>
        value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");

      const renderRows = (rows: UserTaskRow[]) => {
        if (tableHead) {
          tableHead.innerHTML = `<tr>${columns
            .map((column) => `<th>${String(column.header ?? "")}</th>`)
            .join("")}</tr>`;
        }

        if (!tableBody) {
          return;
        }

        if (rows.length === 0) {
          tableBody.innerHTML = "<tr><td colspan=\"4\">No rows yet. Use Header Table menu.</td></tr>";
          return;
        }

        tableBody.innerHTML = rows
          .map(
            (row) =>
              `<tr>${columns
                .map((column) => {
                  const key = column.id;
                  const value = key ? row[key as keyof UserTaskRow] : "";
                  return `<td>${escapeHtml(String(value ?? ""))}</td>`;
                })
                .join("")}</tr>`,
          )
          .join("");
      };

      lenis.on("scroll", () => {
        window.clearTimeout(snapTimer);
        snapTimer = window.setTimeout(snapToNearestSection, 120);
      });

      const raf = (time: number) => {
        lenis.raf(time);
        rafId = window.requestAnimationFrame(raf);
      };

      rafId = window.requestAnimationFrame(raf);

      allAnchorLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
          if (link.matches("[data-table-action]")) {
            return;
          }
          const href = link.getAttribute("href");
          if (!href || !href.startsWith("#")) {
            return;
          }

          const target = document.querySelector<HTMLElement>(href);
          if (!target) {
            return;
          }

          event.preventDefault();
          lenis.scrollTo(target, { duration: 0.8, lock: true });
          setMenuOpen(false);
        });
      });

      tableActionLink?.addEventListener("click", async (event) => {
        event.preventDefault();
        const current = seedCount;
        rows.push(
          {
            userName: `User ${current}`,
            userEmail: `user${current}@example.com`,
            taskTitle: `Task ${current}-1`,
            taskStatus: "todo",
          },
          {
            userName: `User ${current}`,
            userEmail: `user${current}@example.com`,
            taskTitle: `Task ${current}-2`,
            taskStatus: "in-progress",
          },
        );
        seedCount += 1;
        renderRows(rows);

        const tableSection = document.querySelector<HTMLElement>("#table-section");
        if (tableSection) {
          lenis.scrollTo(tableSection, { duration: 0.8, lock: true });
        }
        setMenuOpen(false);
      });

      menuButton?.setAttribute("aria-controls", "mobile-sidemenu");
      menuButton?.setAttribute("aria-expanded", "false");

      menuButton?.addEventListener("click", () => {
        const open = !document.body.classList.contains("menu-open");
        setMenuOpen(open);
      });

      menuOverlay?.addEventListener("click", () => setMenuOpen(false));
      closeButton?.addEventListener("click", () => setMenuOpen(false));
      menuLinks.forEach((link) => link.addEventListener("click", () => setMenuOpen(false)));

      window.addEventListener("resize", () => {
        if (window.innerWidth >= 768) {
          setMenuOpen(false);
        }
      });

      window.addEventListener("beforeunload", () => {
        window.cancelAnimationFrame(rafId);
        lenis.destroy();
      });

      renderRows([]);
    </script>
  </body>
</html>
